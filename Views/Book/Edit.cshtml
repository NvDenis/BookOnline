@model BookUploadViewModel
@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Chỉnh sửa sách";
}

<h2>Chỉnh sửa sách</h2>


<form asp-action="Edit" asp-route-id="@Model.Book._id" method="post" enctype="multipart/form-data">
    <!-- Đảm bảo có AntiForgeryToken -->
    @Html.AntiForgeryToken()
    <!-- ✅ PHẢI có dòng này để truyền lại _id khi POST -->
    <input type="hidden" asp-for="Book._id" />
    <div class="mt-2" id="preview-container">
        @foreach (var img in GetAllImages(Model.Book?.imgs))
        {
            <img src="@img" style="max-width: 120px; margin: 5px; border: 1px solid #ccc;" />
        }
    </div>
    <div class="mb-3">
        <label class="form-label">Ảnh minh họa</label>
        <input asp-for="ImageFiles" type="file" class="form-control" multiple onchange="previewImages(this)" />
    </div>
    <div class="mb-3">
        <label class="form-label">Tên sách</label>
        <input asp-for="Book.name" class="form-control" />
    </div>
   
    <div class="mb-3">
        <label class="form-label">Giá bán</label>
        <input asp-for="Book.price" class="form-control" />
    </div>
    <div class="mb-3">
        <label class="form-label">Giá gốc</label>
        <input asp-for="Book.price_original" class="form-control" />
    </div>
    <div class="mb-3">
        <label class="form-label">Mô tả</label>
        <textarea asp-for="Book.description" id="Description" class="form-control"></textarea>
    </div>
    <div class="mb-3">
        <label class="form-label">Nhà xuất bản</label>
        <select asp-for="Book.id_publisher" asp-items="ViewBag.Publishers" class="form-control mb-3">
            <option value="">-- Chọn nhà xuất bản --</option>
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label">Chủ đề</label>
        <select asp-for="Book.id_topic" asp-items="ViewBag.Topics" class="form-control mb-3">
            <option value="">-- Chọn chủ đề --</option>
        </select>
    </div>



    <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
    <a href="/admin/book" class="btn btn-secondary">Quay lại</a>
</form>


@section Scripts {
    <script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>
    <script>
        CKEDITOR.replace('Description');


        function previewImages(input) {
            const container = document.getElementById('preview-container');
            container.innerHTML = ''; // clear preview

            const files = input.files;
            for (let i = 0; i < files.length; i++) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '120px';
                    img.style.margin = '5px';
                    img.style.border = '1px solid #ccc';
                    container.appendChild(img);
                };
                reader.readAsDataURL(files[i]);
            }
        }
    </script>
}


@functions {
    public List<string> GetAllImages(string imgsJson)
    {
        if (string.IsNullOrEmpty(imgsJson)) return new List<string>();
        try
        {
            return System.Text.Json.JsonSerializer.Deserialize<List<string>>(imgsJson) ?? new List<string>();
        }
        catch
        {
            return new List<string>();
        }
    }
}